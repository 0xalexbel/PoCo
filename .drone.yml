pipeline:
  build:
    image: node:latest
    commands:
      - sed -i '/ethereumjs-util/d' package.json
      - npm install
      - ./node_modules/.bin/truffle compile
      - mkdir ./build/contracts-min
      - for f in $(ls ./build/contracts); do cat ./build/contracts/$f | ./node_modules/.bin/jqn 'pick(["abi","networks"])' --color=false -j >> ./build/contracts-min/$f; done
    when:
      ref: [refs/tags/v*]

  npm:
    image: plugins/npm
    secrets: [npm_password]
    username: sulliwane
    email: sulliwane@gmail.com
    tag: next
    when:
      ref: [refs/tags/v3*]

  dockerhub:
    image: plugins/docker
    repo: iexechub/poco-chain
    secrets: [docker_username, docker_password]
    tags:
      - latest
      - ${DRONE_TAG##v}
    when:
      ref: [refs/tags/v3*]

  dockerhub_legacy:
    image: plugins/docker
    repo: iexechub/poco-chain
    secrets: [docker_username, docker_password]
    tags:
      - legacy-latest
      - legacy-${DRONE_COMMIT_SHA:0:7}
    when:
      branch:
      - testdocker
      event:
      - push

  dockerhub_legacy_20s:
    image: plugins/docker
    repo: iexechub/poco-chain
    secrets: [docker_username, docker_password]
    dockerfile: Dockerfile_20sec
    tags:
      - legacy-20s-${DRONE_COMMIT_SHA:0:7}
    when:
      branch:
      - testdocker
      event:
      - push

  kovan_legacy:
    image: node:latest
    commands:
      - sed -i '/ethereumjs-util/d' package.json
      - npm install
      - ./node_modules/.bin/truffle migrate --network kovan
    secrets: [ deployer_mnemonic ]
    when:
      branch:
      - testdocker
      event:
      - push



